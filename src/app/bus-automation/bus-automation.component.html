<style>
  h4 {
    margin: 0;
    font-weight: 500;
    font-size: 2em;
  }

  .styled-button {
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    font-size: 16px;
    font-weight: bold;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.3s ease;
    outline: none;
    /* Remove default outline */
  }

  .left-buttons button {
    background: linear-gradient(135deg, #FC5923 0%, #4169E0 100%);
  }

  .styled-button:hover {
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    transform: translateY(-2px);
  }

  .styled-button:active {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    transform: translateY(0);
    color: white;
    /* Ensure text color stays white */
  }

  #content {
    padding: 3em;
  }

  .text-area {
    margin-top: 1em;
    background-color: white;
    border-radius: 10px;
    height: 50vh;
    overflow-y: auto;
    padding-left: 1em;
    padding-top: 10px;
    border: 5px solid rgb(239 246 255);
  }

  .status-msg {
    padding: 10px 15px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 8px;
    margin-bottom: 10px;
  }

  .status-msg.success {
    background-color: #ecfdf5;
    color: #059669;
    border: 1px solid #d1fae5;
  }

  .status-msg.error {
    background-color: #fef2f2;
    color: #dc2626;
    border: 1px solid #fee2e2;
  }

  .date {
    margin-bottom: 20px;
    margin-top: 10px;
  }

  h1 {
    color: black;
  }

  h5 {
    font-weight: bold;
    font-size: 20px;
    padding-top: 10px;
    padding-bottom: 10px;
  }

  #date {
    text-align: left;
  }

  .error-msg {
    background-color: #fda5a5;
    display: flex;
    /*align-items: center;*/
    gap: 5px;
    padding: 10px;
    border-radius: 5px;
  }

  .error-text {
    color: #b63f3f;
    margin: 0;
    font-weight: 600;
  }

  .loading-placeholder {
    display: flex;
    position: absolute;
    flex-direction: column;
    gap: 10px;
    /* Space between loading lines */
    width: 50%;
    margin: 20px auto;
    /* Center the placeholder */
  }

  .loading-title,
  .loading-line {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 5px;
  }

  .loading-title {
    width: 60%;
    /* Adjust width for title */
    height: 20px;
  }

  .loading-line {
    width: 100%;
    /* Full width for content lines */
    height: 15px;
  }

  @keyframes shimmer {
    0% {
      background-position: -200% 0;
    }

    100% {
      background-position: 200% 0;
    }
  }

  .edit-button {
    background: #FC5923FF;
    /* Blue background */
    color: white;
    border: none;
    border-radius: 5px;
    margin-bottom: 10px;
  }

  #sub-header {
    color: #818181;
    font-weight: 500;
    font-size: 0.8em;
  }

  h3 {
    font-weight: 500;
    font-size: 2em;
  }
</style>

<div style="margin-bottom: 20px">
  <h3>Bus Automation</h3>
  <p id="sub-header">Allocate passengers into buses here</p>
  <form [formGroup]="form" (ngSubmit)="Authorize()" style="padding-left: 0; display: flex; gap: 10px; flex-wrap: wrap">
    <div class="">
      <div class="input-group">
        <span class="input-group-addon">AccessKey</span>
        <input class="form-control" formControlName="accessKey" name="access-key" type="text" required />
      </div>
    </div>
    <div class="">
      <div class="input-group">
        <span class="input-group-addon">SecretKey</span>
        <input class="form-control" formControlName="secretKey" name="secret-key" type="text" required />
      </div>
    </div>
    <div class="">
      <button *ngIf="!isAuthorized; else notAuthorized" type="submit" class="btn"
        style="background-color: #FC5923; color: white"><i class="bi bi-lock-fill" style="color: white"></i>
        Authorize</button>
      <ng-template #notAuthorized>
        <button type="submit" class="btn" style="background-color: #FC5923; color: white"><i class="bi bi-unlock-fill"
            style="color: white"></i> Logout</button>
      </ng-template>
    </div>
  </form>
</div>
<div class="date" style="display: flex; flex-wrap: wrap; align-items: center; gap: 10px">
  <div class="input-group" style="flex-grow: 0; width: auto">
    <span class="input-group-addon"><i class="glyphicon glyphicon-calendar"></i></span>
    <input id="date" type="date" class="form-control" [value]="date" (change)="onDateChange($event)" />
  </div>
  <div>
    <button type="button" class="btn btn-primary" style="background-color: #4169E0; color: white; margin-right: 10px"
      (click)="getPrevDayPassengers()">Previous day</button>
    <button type="button" class="btn btn-primary" style="background-color: #4169E0; color: white"
      (click)="getNextDayPassengers()">Next day</button>
  </div>
</div>

<!-- Driver Notes Modal -->
<div class="modal-backdrop" *ngIf="isNotesModalOpen" (click)="closeNotesModal()"></div>
<div class="modal-dialog" *ngIf="isNotesModalOpen">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h5 class="modal-title">
        <i class="bi bi-sticky"></i>
        Notes for {{ getDriverNameById(getSelectedDriver(currentNotesBusId, currentNotesTime)) }} - Bus {{
        currentNotesBusId }}
      </h5>
      <button type="button" class="btn-close" (click)="closeNotesModal()" aria-label="Close">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="modal-body">
      <textarea class="form-control notes-textarea" [(ngModel)]="editingNotes"
        placeholder="Add special instructions, pickup changes, or important information for the driver..." rows="6"
        autofocus></textarea>
      <small class="text-muted">These notes will be visible to the driver in the driver portal.</small>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" (click)="closeNotesModal()">Cancel</button>
      <button type="button" class="btn btn-primary" (click)="saveNotes()">Save Notes</button>
    </div>
  </div>
</div>
<div *ngIf="errorMsg.length > 0" class="error-msg col-md-6">
  <i class="bi bi-exclamation-circle" style="color: #b63f3f"></i>
  <p class="error-text">{{errorMsg}}</p>
</div>
<div *ngIf="loading" class="loading-placeholder">
  <div class="loading-title"></div>
  <div class="loading-line"></div>
  <div class="loading-line"></div>
  <div class="loading-line"></div>
</div>
<div *ngIf="loadContent && !loading">
  <button type="button" class="edit-button btn" (click)="toggleEditCapacities()">Edit Bus Capacities</button>
  <div class="row" *ngIf="canEdit">
    <div *ngFor="let bus of allBuses" class="form-group col-lg-1 col-md-2 col-sm-4">
      <label [for]="'input' + '-' + bus.busId" style="font-size: 1.1em" class="">{{ bus.busId }}</label>
      <input role="switch" type="number" class="form-control" [value]="bus.capacity" [id]="'input' + '-' + bus.busId"
        (change)="editCapacity(bus.busId, $event)" />
    </div>
  </div>
  <h4>Passenger List</h4>

  <!-- Unsorted Passengers Warning -->
  <div class="status-msg error" *ngIf="getUnsortedPassengerTimes().length > 0"
    style="margin-top: 10px; margin-bottom: 15px;">
    <i class="bi bi-exclamation-triangle-fill"></i>
    <span>Warning! There are passengers who have not been sorted into buses at: {{ getUnsortedTimesFormatted() }}</span>
  </div>

  <div *ngFor="let time of cachedTimeSlots; trackBy: trackByTimeSlot">

    <h5>{{time[0][0] === "0" ? time[0].slice(1) : time[0]}} - {{time[1]}} Passengers</h5>
    <app-bus-selection-buttons (removeBuses)="resetBusesForTime($event)" [time]="time[0]" [usedBuses]="usedBuses"
      (updatedUsedBuses)="updateUsedBuses($event)" (updateCheckList)="updateBusSelections($event)"
      [successMap]="successMap" [selectedOptions]="busSelections" [buses]="allBuses" [drivers]="drivers"
      [busToDriverMap]="busToDriverMap" (driverAssigned)="onDriverAssigned($event)">
    </app-bus-selection-buttons>
    <button type="button" class="btn btn-info" style="margin-top: 15px;"
      (click)="isPickupToBusOpen.set(time[0], !isPickupToBusOpen.get(time[0]))">Map Pickup to Bus</button>
    <ng-container *ngIf="isPickupToBusOpen.get(time[0])">
      <h5 class="mb-0">Set pickup location to specific bus</h5>
      <h6 class="mt-1 fs-4">Must choose buses first in order to appear below</h6>
      <div class="row m-0 g-3">
        <div *ngFor="let pickup of getPickupAbbrevByTime(time[0])" class="p-4 bg-white col-lg-4 col-md-6 col-sm-12">
          <div class="">
            {{pickup}}
            <div class="radio-buttons">
              <label [for]="'any - ' + pickup + '-' + time[0]" class="radio-inline">
                <input [checked]="!scheduleMap.get(time[0])?.has(pickup)" [id]="'any - ' + pickup + '-' + time[0]"
                  type="radio" [value]="" (change)="removePickup(pickup, time[0])" />
                any
              </label>
              <ng-container *ngFor="let bus of busSelections.get(time[0])">
                <label [for]="bus + '-' + pickup + '-' + time[0]" class="radio-inline">
                  <input [id]="bus + '-' + pickup + '-' + time[0]" type="radio"
                    [name]="'busGroup-' + pickup + '-' + time[0]" [value]="bus"
                    [checked]="bus === scheduleMap.get(time[0])?.get(pickup)"
                    (change)="updatePickupBusList(pickup, bus, time[0])" />
                  {{ bus }}
                </label>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- Driver Assignment (Moved from child component) -->
    <div class="driver-section" *ngIf="successMap.get(time[0])?.[0] && drivers.length > 0">
      <div class="driver-title">
        <div style="display: flex; align-items: center; gap: 6px;">
          <i class="bi bi-person-badge"></i>
          <span>Assign Drivers to Sorted Buses</span>
        </div>
      </div>

      <div class="form-check form-switch" *ngIf="announcementText"
        style="margin-bottom: 15px; display: flex; align-items: center;">
        <input class="form-check-input" type="checkbox" role="switch" [id]="'announcement-'+time[0]"
          (change)="toggleAnnouncement(time[0], $event)" [checked]="includeAnnouncement.get(time[0]) ?? true">
        <label class="form-check-label" [for]="'announcement-'+time[0]"
          style="margin-left: 8px; margin-bottom: 0; cursor: pointer; font-weight: normal;">Include Announcement</label>
      </div>

      <div class="driver-grid">
        <div class="driver-row" *ngFor="let busId of usedBuses.get(time[0])">
          <span class="chip-label">{{ busId }}</span>

          <!-- Native select for driver selection -->
          <select class="driver-select form-control" [ngModel]="getSelectedDriver(busId, time[0])"
            (ngModelChange)="onDriverAssigned({ busId: busId, driverId: $event, time: time[0] })">
            <option value="">-- Select Driver --</option>
            <option *ngFor="let driver of drivers" [value]="driver.docId"
              [disabled]="isDriverAssignedElsewhere(driver.docId || '', busId, time[0])">
              {{ driver.name }}
            </option>
          </select>

          <!-- Notes button - appears when driver is selected -->
          <button type="button" class="btn btn-sm notes-btn" [class.has-notes]="hasNotes(busId, time[0])"
            *ngIf="getSelectedDriver(busId, time[0])" (click)="openNotesModal(busId, time[0])"
            title="Add notes for driver">
            <i class="bi" [class.bi-sticky]="!hasNotes(busId, time[0])"
              [class.bi-sticky-fill]="hasNotes(busId, time[0])"></i>
          </button>

          <i class="bi bi-check-circle-fill" style="color: #10b981;" *ngIf="getSelectedDriver(busId, time[0])"></i>
        </div>
      </div>
    </div>
    <h5 class="mb-0" *ngIf="!getBusesByTime(time[0])">Passengers</h5>
    <div *ngIf="getBusesByTime(time[0]); then isAllocated else isNotAllocated"></div>
    <ng-template #isAllocated>
      <div *ngIf="excludedPassengersMap.has(time[0]) && (excludedPassengersMap.get(time[0])?.length || 0) > 0">
        <h5>Unsorted Passengers</h5>
        <div class="row">
          <div class="col-lg-4 col-md-6 col-sm-12"
            *ngFor="let passenger of excludedPassengersMap.get(time[0]); trackBy: trackByConfirmationID">
            <app-passenger (updateAllowEditBus)="updateAllowEditBus($event)" [selectedPassengerBus]="passengerToBusMap"
              (updatePassengerBusList)="updatePassengerBusList($event)" [selectedBuses]="busSelections"
              [buses]="allBuses" [pickupAbbrevs]="pickupAbbrevs" [excludedPassengers]="excludedPassengers"
              (updatePassengerExclusionList)="updatePassengerExclusionList($event)" [passengerInfo]="passenger"
              [busColor]="'#4169E0'" [isInUnsortedSection]="true"></app-passenger>
          </div>
        </div>
      </div>
      <div *ngFor="let bus of getBusesByTime(time[0])">
        <h5>Bus ({{bus.busId}}) - {{bus.getCurrentLoad()}} Passengers</h5>
        <div class="row">
          <div class="col-lg-4 col-md-6 col-sm-12"
            *ngFor="let passenger of getSortedPassengers(bus.getPassengers()); trackBy: trackByConfirmationID">
            <app-passenger [selectedPassengerBus]="passengerToBusMap" (updateAllowEditBus)="updateAllowEditBus($event)"
              (updatePassengerBusList)="updatePassengerBusList($event)" [selectedBuses]="busSelections"
              [buses]="allBuses" [pickupAbbrevs]="pickupAbbrevs" [excludedPassengers]="excludedPassengers"
              (updatePassengerExclusionList)="updatePassengerExclusionList($event)" [passengerInfo]="passenger"
              [busColor]="bus.color"></app-passenger>
          </div>
        </div>
      </div>
    </ng-template>
    <ng-template #isNotAllocated>
      <div class="row">
        <div *ngFor="let passenger of getPassengersByTime(time[0]); trackBy: trackByConfirmationID"
          class="col-lg-4 col-md-6 col-sm-12">
          <app-passenger (updateAllowEditBus)="updateAllowEditBus($event)" [selectedPassengerBus]="passengerToBusMap"
            (updatePassengerBusList)="updatePassengerBusList($event)" [selectedBuses]="busSelections" [buses]="allBuses"
            [pickupAbbrevs]="pickupAbbrevs" [excludedPassengers]="excludedPassengers"
            (updatePassengerExclusionList)="updatePassengerExclusionList($event)" [passengerInfo]="passenger"
            [busColor]="'#4169E0'"></app-passenger>
        </div>
      </div>
    </ng-template>
  </div>
  <div style="margin-top: 20px" class="">
    <!-- Toast Notification -->
    <div *ngIf="toast" class="toast-notification" [class.success]="toast.type === 'success'"
      [class.error]="toast.type === 'error'">
      <i class="bi" [class.bi-check-circle-fill]="toast.type === 'success'"
        [class.bi-exclamation-circle-fill]="toast.type === 'error'"></i>
      <span>{{ toast.message }}</span>
    </div>

    <!-- Buttons Row -->
    <div class="action-buttons-container">
      <div class="left-buttons">
        <button type="button" class="styled-button" (click)="emailList()" [disabled]="sendingEmail">
          <span *ngIf="!sendingEmail"><i class="bi bi-envelope" style="margin-right: 5px;"></i>Email List</span>
          <span *ngIf="sendingEmail">Sending...</span>
        </button>
        <button type="button" class="styled-button copy-btn" (click)="copyText()">Copy Text</button>
      </div>
    </div>

    <!-- Floating Publish Button -->
    <button type="button" class="styled-button publish-btn floating-action-btn" (click)="publishToDriverPortal()"
      [disabled]="isPublishing || usedBuses.size === 0">
      <span *ngIf="!isPublishing"><i class="bi bi-cloud-upload" style="margin-right: 5px; "></i>Save &
        Publish</span>
      <span *ngIf="isPublishing">Publishing...</span>
    </button>

    <div class="text-area" id="generated-txt" contenteditable="true" [innerHTML]="htmlContent">
    </div>
  </div>